{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}
{% load date_filters %}

{% block title %}Customers{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-6"><h4>Customers</h4></div>
      <div class="col-6">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}"><i class="fa fa-home"></i></a></li>
          <li class="breadcrumb-item active">Customers</li>
        </ol>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12">
      <form method="get" class="card p-3">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">Search</label>
            <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Name, phone, email, code">
          </div>
          <div class="col-md-4">
            <label class="form-label">Type</label>
            <select name="type" class="form-select">
              <option value="">All</option>
              <option value="government" {% if request.GET.type=='government' %}selected{% endif %}>Government</option>
              <option value="ngo" {% if request.GET.type=='ngo' %}selected{% endif %}>NGO</option>
              <option value="company" {% if request.GET.type=='company' %}selected{% endif %}>Private Company</option>
              <option value="personal" {% if request.GET.type=='personal' %}selected{% endif %}>Personal</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Status</label>
            <select name="status" class="form-select">
              <option value="">All</option>
              <option value="active" {% if request.GET.status=='active' %}selected{% endif %}>Active</option>
              <option value="inactive" {% if request.GET.status=='inactive' %}selected{% endif %}>Inactive</option>
              <option value="returning" {% if request.GET.status=='returning' %}selected{% endif %}>Returning</option>
            </select>
          </div>
          <div class="col-md-1 ms-auto">
            <button class="btn btn-primary w-100" type="submit"><i class="fa fa-search me-1"></i> Find</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-4"><div class="card"><div class="card-body d-flex justify-content-between"><span>Active Today</span><span class="fw-bold">{{ active_customers }}</span></div></div></div>
    <div class="col-md-4"><div class="card"><div class="card-body d-flex justify-content-between"><span>New Today</span><span class="fw-bold">{{ new_customers_today }}</span></div></div></div>
    <div class="col-md-4"><div class="card"><div class="card-body d-flex justify-content-between"><span>Returning</span><span class="fw-bold">{{ returning_customers }}</span></div></div></div>
  </div>

  <div class="card">
    <div class="card-body table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Type</th>
            <th>Total Visits</th>
            <th>Last Visit</th>
            {% if user.is_superuser %}<th>Branch</th>{% endif %}
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for c in customers %}
          <tr>
            <td>{{ c.code }}</td>
            <td><a href="{% url 'tracker:customer_detail' pk=c.id %}">{{ c.full_name }}</a></td>
            <td>{{ c.phone }}</td>
            <td>
              {% if c.customer_type %}<span class="badge bg-secondary">{{ c.get_customer_type_display }}</span>{% else %}<span class="badge bg-light text-dark">Personal</span>{% endif %}
            </td>
            <td>{{ c.total_visits }}</td>
            <td>{% if c.last_visit %}{{ c.last_visit|localtime|date_medium }}{% else %}-{% endif %}</td>
            {% if user.is_superuser %}<td>{{ c.branch }}</td>{% endif %}
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="{% url 'tracker:create_order_for_customer' pk=c.id %}"><i class="fa fa-plus me-1"></i> Order</a>
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'tracker:customer_edit' pk=c.id %}"><i class="fa fa-edit"></i></a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="8" class="text-center text-muted">No customers found</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="d-flex justify-content-between align-items-center">
        <div class="small text-muted">Page {{ customers.number }} of {{ customers.paginator.num_pages }}</div>
        <nav>
          <ul class="pagination mb-0">
            {% if customers.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1">&laquo;</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ customers.previous_page_number }}">Prev</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            <li class="page-item disabled"><span class="page-link">Prev</span></li>
            {% endif %}
            {% if customers.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ customers.next_page_number }}">Next</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ customers.paginator.num_pages }}">&raquo;</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>
{% endblock %}
