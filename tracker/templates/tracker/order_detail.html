{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}
{% load date_filters %}

{% block title %}Order Details{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-6"><h4>Order {{ order.order_number }}</h4></div>
      <div class="col-6">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'tracker:orders_list' %}"><i class="fa fa-list"></i></a></li>
          <li class="breadcrumb-item active">Details</li>
        </ol>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header"><h6 class="mb-0">Overview</h6></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="mb-2"><span class="text-muted">Customer</span><div><a href="{% url 'tracker:customer_detail' pk=order.customer.id %}">{{ order.customer.full_name }}</a></div></div>
              <div class="mb-2"><span class="text-muted">Type</span><div>
                {% if order.type == 'service' %}<span class="badge bg-primary">Service</span>
                {% elif order.type == 'sales' %}<span class="badge bg-success">Sales</span>
                {% elif order.type == 'inquiry' %}<span class="badge bg-info text-dark">Inquiry</span>
                {% else %}<span class="badge bg-secondary">{{ order.type }}</span>{% endif %}
              </div></div>
              <div class="mb-2"><span class="text-muted">Priority</span><div>
                {% if order.priority == 'low' %}<span class="badge bg-light text-dark">Low</span>
                {% elif order.priority == 'medium' %}<span class="badge bg-info text-dark">Medium</span>
                {% elif order.priority == 'high' %}<span class="badge bg-primary">High</span>
                {% elif order.priority == 'urgent' %}<span class="badge bg-danger">Urgent</span>
                {% else %}<span class="badge bg-secondary">{{ order.priority }}</span>{% endif %}
              </div></div>
              {% if user.is_superuser %}
              <div class="mb-2"><span class="text-muted">Branch</span><div>{{ order.branch }}</div></div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <div class="mb-2"><span class="text-muted">Status</span><div>
                {% if order.status == 'created' %}<span class="badge bg-secondary">Start</span>
                {% elif order.status == 'in_progress' %}<span class="badge bg-warning text-dark">In Progress</span>
                {% elif order.status == 'overdue' %}<span class="badge bg-danger">Overdue</span>
                {% elif order.status == 'completed' %}<span class="badge bg-success">Completed</span>
                {% elif order.status == 'cancelled' %}<span class="badge bg-dark">Cancelled</span>
                {% else %}<span class="badge bg-light text-dark">{{ order.status }}</span>{% endif %}
              </div></div>
              <div class="mb-2"><span class="text-muted">Created</span><div>{{ order.created_at|localtime|date_medium }}</div></div>
              <div class="mb-2"><span class="text-muted">Started</span><div>{% if order.started_at %}{{ order.started_at|localtime|date_medium }}{% else %}-{% endif %}</div></div>
              <div class="mb-2"><span class="text-muted">Completed</span><div>{% if order.completed_at %}{{ order.completed_at|localtime|date_medium }}{% else %}-{% endif %}</div></div>
              <div class="mb-2"><span class="text-muted">Cancelled</span><div>{% if order.cancelled_at %}{{ order.cancelled_at|localtime|date_medium }}{% else %}-{% endif %}</div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header"><h6 class="mb-0">Files & Sign-off</h6></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="mb-2"><span class="text-muted">Signed By</span><div>{% if order.signed_by %}{{ order.signed_by.get_full_name|default:order.signed_by.username }}{% else %}-{% endif %}</div></div>
              <div class="mb-2"><span class="text-muted">Signed At</span><div>{% if order.signed_at %}{{ order.signed_at|localtime|date_medium }}{% else %}-{% endif %}</div></div>
            </div>
            <div class="col-md-6">
              {% if order.signature_file %}
              <div class="mb-2"><span class="text-muted">Signature</span><div><img src="{{ order.signature_file.url }}" alt="Signature" class="img-fluid rounded"></div></div>
              {% endif %}
              {% if order.completion_attachment %}
              <div class="mb-2"><span class="text-muted">Attachment</span><div><a href="{{ order.completion_attachment.url }}" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="fa fa-paperclip me-1"></i> View Attachment</a></div></div>
              {% endif %}
              {% if not order.signature_file and not order.completion_attachment %}
              <div class="text-muted">No files attached.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      {% if order.status != 'completed' and order.status != 'cancelled' %}
      <div class="card mt-3">
        <div class="card-header"><h6 class="mb-0">Complete Order</h6></div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" action="{% url 'tracker:complete_order' pk=order.id %}">
            {% csrf_token %}
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Signature Image</label>
                <input type="file" name="signature_file" accept="image/*" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Completion Attachment</label>
                <input type="file" name="completion_attachment" class="form-control">
              </div>
            </div>
            <p class="small text-muted mt-2 mb-0">Upload either a signature image or an attachment (one is required).</p>
            <div class="mt-3 d-flex gap-2">
              <button class="btn btn-success" type="submit"><i class="fa fa-check me-1"></i> Mark as Completed</button>
              <a class="btn btn-outline-secondary" href="{% url 'tracker:order_edit' pk=order.id %}"><i class="fa fa-edit me-1"></i> Edit</a>
            </div>
          </form>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header"><h6 class="mb-0">Cancel Order</h6></div>
        <div class="card-body">
          <form method="post" action="{% url 'tracker:cancel_order' pk=order.id %}">
            {% csrf_token %}
            <label class="form-label">Reason</label>
            <textarea name="reason" class="form-control" rows="3" required></textarea>
            <div class="mt-3">
              <button class="btn btn-danger" type="submit"><i class="fa fa-times me-1"></i> Cancel Order</button>
            </div>
          </form>
        </div>
      </div>
      {% endif %}
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-header"><h6 class="mb-0">Actions</h6></div>
        <div class="card-body d-grid gap-2">
          <a href="{% url 'tracker:orders_list' %}" class="btn btn-outline-primary"><i class="fa fa-arrow-left me-1"></i> Back to Orders</a>
          <a href="{% url 'tracker:order_edit' pk=order.id %}" class="btn btn-outline-secondary"><i class="fa fa-edit me-1"></i> Edit</a>
          <form method="post" action="{% url 'tracker:order_delete' pk=order.id %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{% url 'tracker:orders_list' %}">
            <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Delete this order?');"><i class="fa fa-trash me-1"></i> Delete</button>
          </form>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header"><h6 class="mb-0">Timestamps</h6></div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            <li class="mb-1"><span class="text-muted">Created:</span> {{ order.created_at|localtime|date_medium }}</li>
            <li class="mb-1"><span class="text-muted">Started:</span> {% if order.started_at %}{{ order.started_at|localtime|date_medium }}{% else %}-{% endif %}</li>
            <li class="mb-1"><span class="text-muted">Completed:</span> {% if order.completed_at %}{{ order.completed_at|localtime|date_medium }}{% else %}-{% endif %}</li>
            <li class="mb-1"><span class="text-muted">Cancelled:</span> {% if order.cancelled_at %}{{ order.cancelled_at|localtime|date_medium }}{% else %}-{% endif %}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
