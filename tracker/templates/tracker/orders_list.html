{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}
{% load date_filters %}

{% block title %}Orders{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-6"><h4>Orders</h4></div>
      <div class="col-6">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}"><i class="fa fa-home"></i></a></li>
          <li class="breadcrumb-item active">Orders</li>
        </ol>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12">
      <form method="get" class="card p-3">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Status</label>
            <select name="status" class="form-select">
              {% with s=status %}
              <option value="all" {% if s=='all' %}selected{% endif %}>All</option>
              <option value="created" {% if s=='created' %}selected{% endif %}>Start</option>
              <option value="in_progress" {% if s=='in_progress' %}selected{% endif %}>In Progress</option>
              <option value="overdue" {% if s=='overdue' %}selected{% endif %}>Overdue</option>
              <option value="completed" {% if s=='completed' %}selected{% endif %}>Completed</option>
              <option value="cancelled" {% if s=='cancelled' %}selected{% endif %}>Cancelled</option>
              {% endwith %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Type</label>
            <select name="type" class="form-select">
              {% with t=type %}
              <option value="all" {% if t=='all' %}selected{% endif %}>All</option>
              <option value="service" {% if t=='service' %}selected{% endif %}>Service</option>
              <option value="sales" {% if t=='sales' %}selected{% endif %}>Sales</option>
              <option value="inquiry" {% if t=='inquiry' %}selected{% endif %}>Inquiry</option>
              {% endwith %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Priority</label>
            <select name="priority" class="form-select">
              <option value="">Any</option>
              <option value="low" {% if request.GET.priority=='low' %}selected{% endif %}>Low</option>
              <option value="medium" {% if request.GET.priority=='medium' %}selected{% endif %}>Medium</option>
              <option value="high" {% if request.GET.priority=='high' %}selected{% endif %}>High</option>
              <option value="urgent" {% if request.GET.priority=='urgent' %}selected{% endif %}>Urgent</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Date Range</label>
            <select name="date_range" class="form-select">
              {% with dr=request.GET.date_range|default:'' %}
              <option value="">Any</option>
              <option value="daily" {% if dr in 'daily,today' %}selected{% endif %}>Today</option>
              <option value="weekly" {% if dr in 'weekly,week' %}selected{% endif %}>Last 7 days</option>
              <option value="monthly" {% if dr in 'monthly,month' %}selected{% endif %}>Last 30 days</option>
              <option value="yearly" {% if dr in 'yearly,year' %}selected{% endif %}>This year</option>
              {% endwith %}
            </select>
          </div>
          {% if user.is_superuser %}
          <div class="col-md-2">
            <label class="form-label">Branch (admin)</label>
            <input type="number" name="branch" value="{{ request.GET.branch }}" class="form-control" placeholder="Branch ID">
          </div>
          {% endif %}
          <div class="col-md-2 ms-auto">
            <button class="btn btn-primary w-100" type="submit"><i class="fa fa-filter me-1"></i> Filter</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between"><span>Total Orders</span><span class="fw-bold">{{ total_orders }}</span></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between"><span>Pending</span><span class="fw-bold">{{ pending_orders }}</span></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between"><span>Active</span><span class="fw-bold">{{ active_orders }}</span></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between"><span>Completed Today</span><span class="fw-bold">{{ completed_today }}</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Order</th>
            <th>Customer</th>
            <th>Type</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Created</th>
            <th>Started</th>
            <th>Completed</th>
            <th>Cancelled</th>
            <th>Signed By</th>
            {% if user.is_superuser %}<th>Branch</th>{% endif %}
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for o in orders %}
          <tr>
            <td><a href="{% url 'tracker:order_detail' pk=o.id %}">{{ o.order_number }}</a></td>
            <td><a href="{% url 'tracker:customer_detail' pk=o.customer.id %}">{{ o.customer.full_name }}</a></td>
            <td>
              {% if o.type == 'service' %}<span class="badge bg-primary">Service</span>
              {% elif o.type == 'sales' %}<span class="badge bg-success">Sales</span>
              {% elif o.type == 'inquiry' %}<span class="badge bg-info text-dark">Inquiry</span>
              {% else %}<span class="badge bg-secondary">{{ o.type }}</span>{% endif %}
            </td>
            <td>
              {% if o.status == 'created' %}<span class="badge bg-secondary">Start</span>
              {% elif o.status == 'in_progress' %}<span class="badge bg-warning text-dark">In Progress</span>
              {% elif o.status == 'overdue' %}<span class="badge bg-danger">Overdue</span>
              {% elif o.status == 'completed' %}<span class="badge bg-success">Completed</span>
              {% elif o.status == 'cancelled' %}<span class="badge bg-dark">Cancelled</span>
              {% else %}<span class="badge bg-light text-dark">{{ o.status }}</span>{% endif %}
            </td>
            <td>
              {% if o.priority == 'low' %}<span class="badge bg-light text-dark">Low</span>
              {% elif o.priority == 'medium' %}<span class="badge bg-info text-dark">Medium</span>
              {% elif o.priority == 'high' %}<span class="badge bg-primary">High</span>
              {% elif o.priority == 'urgent' %}<span class="badge bg-danger">Urgent</span>
              {% else %}<span class="badge bg-secondary">{{ o.priority }}</span>{% endif %}
            </td>
            <td>{{ o.created_at|localtime|date_medium }}</td>
            <td>{% if o.started_at %}{{ o.started_at|localtime|date_medium }}{% else %}-{% endif %}</td>
            <td>{% if o.completed_at %}{{ o.completed_at|localtime|date_medium }}{% else %}-{% endif %}</td>
            <td>{% if o.cancelled_at %}{{ o.cancelled_at|localtime|date_medium }}{% else %}-{% endif %}</td>
            <td>{% if o.signed_by %}{{ o.signed_by.get_full_name|default:o.signed_by.username }}{% else %}-{% endif %}</td>
            {% if user.is_superuser %}<td>{{ o.branch }}</td>{% endif %}
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="{% url 'tracker:order_edit' pk=o.id %}"><i class="fa fa-edit"></i></a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="12" class="text-center text-muted">No orders found</td></tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="d-flex justify-content-between align-items-center">
        <div class="small text-muted">Page {{ orders.number }} of {{ orders.paginator.num_pages }}</div>
        <nav>
          <ul class="pagination mb-0">
            {% if orders.has_previous %}
            <li class="page-item"><a class="page-link" href="?{% querystring request.GET 'page' 1 %}">&laquo;</a></li>
            <li class="page-item"><a class="page-link" href="?{% querystring request.GET 'page' orders.previous_page_number %}">Prev</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            <li class="page-item disabled"><span class="page-link">Prev</span></li>
            {% endif %}
            {% if orders.has_next %}
            <li class="page-item"><a class="page-link" href="?{% querystring request.GET 'page' orders.next_page_number %}">Next</a></li>
            <li class="page-item"><a class="page-link" href="?{% querystring request.GET 'page' orders.paginator.num_pages %}">&raquo;</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>
{% endblock %}