{% extends 'tracker/base.html' %}
{% load static %}
{% block title %}Analytics Overview{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-6"><h4>Analytics Overview</h4></div>
      <div class="col-6">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}"><svg class="stroke-icon"><use href="../assets/svg/icon-sprite.svg#stroke-home"></use></svg></a></li>
          <li class="breadcrumb-item active">Analytics</li>
        </ol>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-xxl-3 col-sm-6">
      <div class="card h-100"><div class="card-body">
        <h6 class="mb-1">Total Orders</h6>
        <h3 class="f-w-600 mb-0">{{ totals.total_orders|default:0 }}</h3>
      </div></div>
    </div>
    <div class="col-xxl-3 col-sm-6">
      <div class="card h-100"><div class="card-body">
        <h6 class="mb-1">Completed</h6>
        <h3 class="f-w-600 mb-0">{{ totals.completed|default:0 }}</h3>
      </div></div>
    </div>
    <div class="col-xxl-3 col-sm-6">
      <div class="card h-100"><div class="card-body">
        <h6 class="mb-1">In Progress</h6>
        <h3 class="f-w-600 mb-0">{{ totals.in_progress|default:0 }}</h3>
      </div></div>
    </div>
    <div class="col-xxl-3 col-sm-6">
      <div class="card h-100"><div class="card-body">
        <h6 class="mb-1">New Customers</h6>
        <h3 class="f-w-600 mb-0">{{ totals.customers|default:0 }}</h3>
      </div></div>
    </div>
  </div>

  <div class="row mt-3">
    <div class="col-xxl-4 col-md-6">
      <div class="card h-100">
        <div class="card-header"><h5>Status</h5></div>
        <div class="card-body"><canvas id="statusPie" width="420" height="260"></canvas></div>
      </div>
    </div>
    <div class="col-xxl-4 col-md-6">
      <div class="card h-100">
        <div class="card-header"><h5>Type</h5></div>
        <div class="card-body"><canvas id="typePie" width="420" height="260"></canvas></div>
      </div>
    </div>
    <div class="col-xxl-4 col-12">
      <div class="card h-100">
        <div class="card-header"><h5>Priority</h5></div>
        <div class="card-body"><canvas id="priorityPie" width="420" height="260"></canvas></div>
      </div>
    </div>
  </div>

  <div class="row mt-3">
    <div class="col-12">
      <div class="card h-100">
        <div class="card-header"><h5>Trend ({{ period|title }})</h5></div>
        <div class="card-body"><canvas id="trendLine" width="1100" height="320"></canvas></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  var charts = JSON.parse({{ charts_json|safe|default:'{}'|escapejs }});
  function pie(canvas, labels, values, colors){
    var ctx = canvas.getContext('2d');
    var total = values.reduce(function(a,b){return a+b;},0) || 1;
    var cx = canvas.width/2, cy = canvas.height/2, r = Math.min(cx, cy) - 10, a=-Math.PI/2;
    for (var i=0;i<values.length;i++){
      var slice = (values[i]/total)*Math.PI*2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a,a+slice); ctx.closePath(); ctx.fillStyle=colors[i%colors.length]; ctx.fill(); a+=slice;
    }
  }
  function line(canvas, labels, values, color){
    var ctx = canvas.getContext('2d');
    var w = canvas.width, h = canvas.height, p=30;
    var max = Math.max.apply(null, values.concat([1]));
    ctx.clearRect(0,0,w,h);
    ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth=1;
    for(var i=0;i<5;i++){ var y = p + (h-2*p)*i/4; ctx.beginPath(); ctx.moveTo(p,y); ctx.lineTo(w-p,y); ctx.stroke(); }
    ctx.strokeStyle = color || '#2563eb'; ctx.lineWidth=2; ctx.beginPath();
    values.forEach(function(v, idx){ var x = p + (w-2*p)*(idx/(Math.max(labels.length-1,1))); var y = h-p - (h-2*p)*(v/max); if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.stroke();
  }
  document.addEventListener('DOMContentLoaded', function(){
    if(charts.status){ pie(document.getElementById('statusPie'), charts.status.labels, charts.status.values, ['#60a5fa','#f59e0b','#22c55e','#94a3b8']); }
    if(charts.type){ pie(document.getElementById('typePie'), charts.type.labels, charts.type.values, ['#4e79a7','#59a14f','#f28e2b']); }
    if(charts.priority){ pie(document.getElementById('priorityPie'), charts.priority.labels, charts.priority.values, ['#a78bfa','#34d399','#f87171','#fbbf24']); }
    if(charts.trend){ line(document.getElementById('trendLine'), charts.trend.labels, charts.trend.values, '#0ea5e9'); }
  });
})();
</script>
{% endblock %}
